= Arquillian Algeron Consumer Publisher

Arquillian Algeron also offers additional ways to of publishing contracts files comparing to what Pact itself is providing.

In Arquillian Algeron we have defined a Pact Publishing SPI so you can implement your own publisher.
We currently support three different publishers - Folder, URL[POST method] and Git.

It is important to note that by default `publishContracts` configuration attribute is `false`.
This means that when you run any consumer contract test, contracts are not published.
`publishContracts` configuration attribute should be only set to `true`if and only if you are publishing a new version of a consumer, and this will be done by your CI/CD environment.

[TIP]
====
Arquillian can be configured using system properties or environment variables.
If you want to enable pact publishing feature only in CI/CD, you can set environment variable `arq.extension.algeron-consumer.publishContracts` to true.
Also you can use the form `<property name="publishContracts">${env.publishcontracts:false}</property>` and setting `publishContracts` environment variable with correct value.
====

== Folder Publisher

Folder publisher copies "pact" files from configured output directory (by default `target/pacts`) to another directory.
To configure folder publisher you need to configure `pactPublishConfiguration` with next configuration:

[source, xml]
.arquillian.xml
----
<?xml version="1.0"?>
<arquillian xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="http://jboss.org/schema/arquillian"
            xsi:schemaLocation="http://jboss.org/schema/arquillian
    http://jboss.org/schema/arquillian/arquillian_1_0.xsd">

    <extension qualifier="algeron-consumer">
        <property name="publishConfiguration">
            provider: folder # <1>
            outputFolder: /mypacts # <2>
            contractsFolder: target/pacts # <3>
        </property>
    </extension>

</arquillian>
----
<1> `provider` attribute is used for setting which publisher to use. In case of Folder publisher, you need to set to `folder`.
<2> `outputFolder` configures where to copy contract files.
<3> `contractsFolder` configures folder where contract files are generated by the engine.

You can set `outputFolder` value using Java system property `${name:defaultvalue} or environment variable `${env.name:defaultvalue}.
For example `outputFolder: ${output:/mypacts}` will first check if there is a Java system property with name output and get the value.
If that is not defined it will use the default value i.e. `/mypacts`.

== URL Publisher

URL publisher sends a `POST` request to configured URL, appending at the end of the URL the "pact" filename and sending the contract content as body content.
For example given `http://myhost/pacts` and a "contract" file called `consumer_provider.json`, the resulting URL would be: `http://myhost/pacts/consumer_provider.json`

[source, xml]
.arquillian.xml
----
<?xml version="1.0"?>
<arquillian xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="http://jboss.org/schema/arquillian"
            xsi:schemaLocation="http://jboss.org/schema/arquillian
    http://jboss.org/schema/arquillian/arquillian_1_0.xsd">

    <extension qualifier="algeron-consumer">
        <property name="publishConfiguration">
            provider: url # <1>
            url: http://localhost:8081/pacts # <2>
            contractsFolder: target/pacts # <3>
        </property>
    </extension>

</arquillian>
----
<1> `provider` attribute is used for setting which publisher to use. In case of URL publisher, you need to set to `url`.
<2> `url` configures to send as `POST` the contract content.
<3> `contractsFolder` configures folder where contract files are generated by the engine.

You can set `url` value using Java system property `${name:defaultvalue}` or environment variable `${env.name:defaultvalue}`.

== Pact Broker

You can publish contracts to Pact Broker server.

[source, xml]
.arquillian.xml
----
<extension qualifier="algeron-provider">
  <property name="retrieverConfiguration">
          provider: pactbroker
          url: <url of pact broker server>
          username: <username to access>
          password: <password to access>
          contractsFolder: <path where pact files are generated>
          version: <version which pacts are stored>
  </property>
</extension>
----

Also you need to add `org.arquillian.algeron:arquillian-algeron-consumer-pact-broker-publisher:${version}` dependency. This is only supported in case of using Pact provider.

Possible attributes:

|===
| Parameter | Description

|url
|Mandatory field that sets url of Pact Broker.

|contractsFolder
|Mandatory field that sets the location of Pact files.

|username
|Optional field that sets the username.

|password
|Optional field that sets the password.

|version
|Optional field that sets the version of contracts in pact broker. If not set `latest` is used.
|===

Notice that all these attributes can be set using system properties or environment variable as any other property in `arquillian.xml`.

== Git Publisher

Git publisher publishes contract files to a git repository.
Optionally they can be committed into a branch or tag the commit.

This publisher just takes the generated contract files, copied to repository, commit them and push them to remote.

First of all you need to add git publisher dependency:

[source, xml]
.pom.xml
----
<dependency>
    <groupId>org.arquillian.algeron</groupId>
    <artifactId>arquillian-algeron-consumer-git-publisher</artifactId>
</dependency>
----

[source, xml]
.arquillian.xml
----
<?xml version="1.0"?>
<arquillian xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="http://jboss.org/schema/arquillian"
            xsi:schemaLocation="http://jboss.org/schema/arquillian
    http://jboss.org/schema/arquillian/arquillian_1_0.xsd">

    <extension qualifier="algeron-consumer">
        <property name="publishConfiguration">
            provider: git # <1>
            url: https://localhost:8080/contracts # <2>
            comment: This is a new version of contracts # <3>
            username: admin # <4>
            password: admin
            passphrase: aaaa # <5>
            key: ~/mykey # <6>
            remote: origin # <7>
            repository: /git/myrepo # <8>
            contractGitDirectory: pacts/ # <9>
            tag: v ${version:1.0.0-SNAPSHOT} # <10>
            branch: master # <11>
            email: my@email.com # <12>
            contractsFolder: target/pacts # <13>
        </property>
    </extension>

</arquillian>
----
<1> `provider` attribute is used for setting which publisher to use. In case of Git publisher, you need to set to `git`.
<2> `url` sets the git repository. This is mandatory field.
<3> `comment` set comment message. This is mandatory field.
<4> `username` and `password` for accessing repository.
<5> `passphrase` to access to private key.
<6> `key` private key location, by default `~/.ssh/id_rsa`.
<7> `remote` repository. By default `origin`.
<8> `repository` sets location of repository. If it is an empty directory, git repository is cloned there. If it is already a git repository, a `git pull` operation is executed. By default a temp directory is created.
<9> `pactDirectory` configures where pact files are stored inside repository. By default gets root directory.
<10> `tag` is used for tagging commit done with new pact files.
<11> `branch` sets a branch where contract files are copied and committed. By default is `master`.
<12> `email` used for commit. By default it gets email from general configuration.
<13> `contractsFolder` configures folder where contract files are generated by the engine.

Any of the git attributes can be set using Java system property `${name:defaultvalue}` or environment variable `${env.name:defaultvalue}`.

== SPI

You can also implement your own publisher.
To make it so you need create a class that implements `org.arquillian.algeron.consumer.spi.publisher.ContractsPublisher` and register this service inside `META-INF/services/org.arquillian.algeron.consumer.spi.publisher.ContractsPublisher`.

You can see an example at https://github.com/arquillian/arquillian-algeron/tree/master/consumer/git-publisher.

== JBoss Forge Arquillian Addon

http://forge.jboss.org[Forge] Arquillian Addon offers an integration with Arquillian Algeron Publishers.

To use it apart from having the Forge Arquillian Addon installed in Forge, you also need to have Arquillian Algeron Consumer dependencies registered on build tool (for example using command `arquillian-algeron-setup-consumer --contracts-library pact` <<JBoss_Forge_Arquillian_Algeron_Consumer_Addon, JBoss Forge Arquillian Consumer Addon>> ).

Each of the publishers have its own command to be registered where you can set its specific configuration parameters.

folder:: `arquillian-algeron-setup-publisher --publisher folder --output-folder /tmp/pacts`
url:: `arquillian-algeron-setup-publisher --publisher url --url http://localhost`
git:: `arquillian-algeron-setup-publisher --publisher git --url http://localhost --comment newcomment`

See it alive in next terminal cast:

image::https://asciinema.org/a/104386.png[link="https://asciinema.org/a/104386"]
